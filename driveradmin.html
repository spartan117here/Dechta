<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Dechta Admin Portal | Operations Control</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { 
               gold: '#facc15',
               dark: '#0f172a',
               cyan: '#0ceded',
               success: '#22c55e',
               danger: '#ef4444',
               warning: '#f97316'
            }
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'fade-in': 'fadeIn 0.5s ease-out forwards',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    body { font-size: 14px; font-family: 'Plus Jakarta Sans', sans-serif; transition: background-color 0.3s, color 0.3s; }
    
    body:not(.dark) { background: #f8fafc; color: #0f172a; }
    .dark body { background: #020617; color: #f8fafc; }
    
    .dark .bg-white { background-color: #0f172a; border-color: #1e293b; }
    .dark .text-gray-800 { color: #f1f5f9; }
    .dark .text-gray-500 { color: #94a3b8; }
    .dark .border-gray-200 { border-color: #1e293b; }
    .dark .bg-gray-50 { background-color: #1e293b; }
    
    .shadow-premium { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .card-hover { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    
    .avatar { width:42px;height:42px;border-radius:999px; background: conic-gradient(from 120deg, #0ceded, #facc15, #ef4444, #38bdf8, #0ceded); display:inline-flex;align-items:center;justify-content:center; font-weight:700;color:white; position:relative; overflow:hidden; }
    .avatar::before{ content:"";position:absolute;inset:2px;border-radius:9999px; background:#0f172a; }
    .avatar span { position:relative; z-index:1; }
    
    #live-map { height: 100%; width: 100%; border-radius: 12px; z-index: 1; }
    .sidebar-fixed { height: 100vh; position: fixed; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #0ceded #000000; }
    .input-field { width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; font-size: 0.875rem; transition: all 0.2s; outline: none; }
    .input-field:focus { border-color: #0ceded; ring: 2px solid #0ceded20; }
    
    .dropdown-animate { transform-origin: top right; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .dropdown-animate.hidden { opacity: 0; transform: scale(0.95) translateY(-10px); pointer-events: none; display: block !important; }

    .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); transition: all 0.3s ease; }
    .modal-content { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

    .marker-pin { width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 12px rgba(0,0,0,0.4); }
    .marker-pulse { animation: markerPulse 1.5s infinite; position: absolute; inset: -6px; border-radius: 50%; opacity: 0.5; }
    @keyframes markerPulse { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.5); opacity: 0; } }

    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }

    /* Order Logic Styling */
    .status-badge { @apply px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider; }
    .route-line { width: 2px; border-left: 2px dashed #cbd5e1; height: 32px; margin-left: 6px; }
    .dark .route-line { border-left-color: #334155; }

    /* Tab Animation */
    .active-tab-glider { transition: all 0.3s ease; }
    .row-suspended { background-color: rgba(239, 68, 68, 0.05) !important; }
    .dark .row-suspended { background-color: rgba(239, 68, 68, 0.1) !important; }

    /* Incentive Bar */
    .progress-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
  </style>
</head>

<body class="min-h-screen text-sm font-medium">

<!-- === GLOBAL MODAL SYSTEM === -->
<div id="global-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
    <div class="bg-white dark:bg-slate-900 w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden border dark:border-slate-800 modal-content">
        <div id="modal-body"></div>
    </div>
</div>

<!-- === LOGIN SECTION === -->
<div id="login-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-white dark:bg-slate-950">
    <div class="bg-white w-full max-w-[420px] rounded-3xl shadow-2xl p-10 border border-gray-100 dark:bg-slate-900 dark:border-slate-800 relative overflow-hidden">
        <div class="absolute -top-24 -right-24 w-64 h-64 bg-cyan-400/10 rounded-full blur-3xl"></div>
        <div class="relative">
            <div class="mb-8">
                <div class="w-12 h-12 bg-black dark:bg-cyan-400 rounded-xl flex items-center justify-center mb-4 shadow-lg">
                    <i class="ph ph-shield-chevron text-2xl text-cyan-400 dark:text-black"></i>
                </div>
                <h1 class="text-3xl font-extrabold tracking-tight dark:text-white">Admin Access</h1>
                <p class="text-gray-500 text-sm mt-2">Dechta Operations Command Center</p>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold uppercase tracking-widest text-gray-400 mb-2">Internal Admin ID</label>
                    <input type="text" id="login-id" class="input-field dark:bg-slate-800 dark:border-slate-700 dark:text-white" value="ADM-7721">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase tracking-widest text-gray-400 mb-2">Access Key</label>
                    <input type="password" id="login-pass" class="input-field dark:bg-slate-800 dark:border-slate-700 dark:text-white" value="1234">
                </div>
                <div class="flex items-center justify-between py-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" checked class="w-4 h-4 rounded border-gray-300 text-cyan-500 focus:ring-cyan-500">
                        <span class="text-xs text-gray-500">Trust this device</span>
                    </label>
                    <a href="#" class="text-xs text-cyan-500 font-bold hover:underline">Reset Key</a>
                </div>
                <button onclick="performLogin()" class="w-full bg-black text-cyan-400 py-4 rounded-2xl font-bold text-sm hover:scale-[1.02] active:scale-95 transition shadow-xl shadow-cyan-500/10 dark:bg-cyan-400 dark:text-black">Authorize Session</button>
            </div>
        </div>
    </div>
</div>

<!-- === MAIN APP === -->
<div id="app-container" class="hidden flex min-h-screen">

  <!-- SIDEBAR -->
  <aside class="hidden lg:flex flex-col w-72 bg-slate-950 text-white p-6 space-y-4 sidebar-fixed z-40">
    <div class="flex flex-col h-full">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="w-10 h-10 bg-cyan-400 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-400/20">
                <i class="ph ph-lightning text-xl text-black font-bold"></i>
            </div>
            <div>
                <div class="text-xl font-black tracking-tight">DECHTA</div>
                <div class="text-[9px] font-bold text-cyan-400 uppercase tracking-[0.2em] leading-none mt-0.5">Control Tower</div>
            </div>
        </div>

        <div class="space-y-1.5 flex-1">
          <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-4 px-2 font-black">Live Ops</div>
          
          <button id="side-dashboard" class="nav-btn w-full text-left px-4 py-3.5 rounded-xl transition font-semibold flex items-center gap-3 group" onclick="navigate('dashboard')">
            <i class="ph ph-compass text-xl group-hover:scale-110 transition"></i> Live Map View
          </button>
          
          <button id="side-orders" class="nav-btn w-full text-left px-4 py-3.5 rounded-xl transition font-semibold flex items-center gap-3 group" onclick="navigate('orders')">
            <i class="ph ph-stack text-xl group-hover:scale-110 transition"></i> Operations Console
            <span class="ml-auto bg-cyan-400 text-black text-[10px] px-1.5 py-0.5 rounded-md font-bold">86</span>
          </button>

          <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500 my-6 px-2 pt-6 font-black border-t border-slate-800">Growth & Finance</div>

          <!-- NEW INCENTIVE ENGINE BUTTON -->
          <button id="side-incentives" class="nav-btn w-full text-left px-4 py-3.5 rounded-xl transition font-semibold flex items-center gap-3 group" onclick="navigate('incentives')">
            <i class="ph ph-trophy text-xl group-hover:scale-110 transition text-brand-gold"></i> Incentive Engine
            <span class="ml-auto w-2 h-2 bg-brand-gold rounded-full animate-pulse"></span>
          </button>

          <button id="side-earnings" class="nav-btn w-full text-left px-4 py-3.5 rounded-xl transition font-semibold flex items-center gap-3 group" onclick="navigate('earnings')">
            <i class="ph ph-chart-line-up text-xl group-hover:scale-110 transition"></i> Finance & Payouts
          </button>
          
          <div class="text-[10px] uppercase tracking-[0.2em] text-slate-500 my-6 px-2 pt-6 font-black border-t border-slate-800">Resources</div>

          <button id="side-roster" class="nav-btn w-full text-left px-4 py-3.5 rounded-xl transition font-semibold flex items-center gap-3 group" onclick="navigate('roster')">
            <i class="ph ph-users-four text-xl group-hover:scale-110 transition"></i> Delivery Partners
          </button>

          <button id="side-profile" class="nav-btn w-full text-left px-4 py-3.5 rounded-xl transition font-semibold flex items-center gap-3 relative group" onclick="navigate('profile')">
             <i class="ph ph-identification-card text-xl group-hover:scale-110 transition"></i> KYC Compliance
             <span class="absolute right-4 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
          </button>

          <button id="side-support" class="nav-btn w-full text-left px-4 py-3.5 rounded-xl transition font-semibold flex items-center gap-3 group" onclick="navigate('support')">
             <i class="ph ph-headset text-xl group-hover:scale-110 transition"></i> Support Desk
          </button>
        </div>
        
        <div class="pt-6 border-t border-slate-800">
            <div class="flex items-center gap-4 bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                <div class="avatar border-2 border-cyan-400/50 w-10 h-10">
                    <span class="avatar-initials text-xs">SA</span>
                </div>
                <div class="flex-1 overflow-hidden">
                    <div class="font-bold text-white text-xs truncate admin-name-display">System Admin</div>
                    <div class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Level 4 Auth</div>
                </div>
                <button onclick="logout()" class="text-slate-400 hover:text-red-400 transition">
                    <i class="ph ph-sign-out text-lg"></i>
                </button>
            </div>
        </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 w-full lg:ml-72 bg-slate-50 dark:bg-slate-950 transition-all duration-300">
    
    <!-- HEADER -->
    <header class="sticky top-0 z-30 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-slate-200 dark:border-slate-800 px-8 py-5 flex items-center justify-between shadow-sm">
       <div class="flex items-center gap-6">
          <div class="lg:hidden">
              <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
                  <i class="ph ph-lightning text-cyan-400"></i>
              </div>
          </div>
          <div class="flex flex-col">
              <h1 id="view-title" class="text-xl font-extrabold tracking-tight dark:text-white">Live Map</h1>
              <div class="flex items-center gap-2 mt-0.5">
                  <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                  <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">System Health: Optimal</span>
              </div>
          </div>
       </div>
       
       <div class="flex items-center gap-4">
          <div class="hidden md:flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
             <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-white dark:hover:bg-slate-700 transition shadow-sm text-slate-500 dark:text-slate-400">
                <i class="theme-icon ph ph-moon text-lg"></i>
             </button>
          </div>

          <div class="relative dropdown-container">
              <button class="relative p-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-black dark:hover:text-white transition shadow-sm" onclick="toggleNotifications()">
                 <i class="ph ph-bell text-xl"></i>
                 <span class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white dark:border-slate-900"></span>
              </button>
              <!-- Notif Panel Injected Here -->
              <div id="notif-panel" class="absolute right-0 top-16 w-96 bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-100 dark:border-slate-800 hidden py-2 z-50 dropdown-animate">
                  <div class="px-5 py-4 border-b dark:border-slate-800 flex justify-between items-center">
                      <h3 class="font-extrabold dark:text-white">Recent Alerts</h3>
                      <button class="text-[10px] text-cyan-500 font-black hover:underline uppercase tracking-widest" onclick="clearNotifs()">Mark All Read</button>
                  </div>
                  <div class="max-h-[400px] overflow-y-auto custom-scrollbar" id="notif-list"></div>
              </div>
          </div>
          
          <div class="relative dropdown-container">
            <button onclick="toggleProfileMenu()" id="profile-btn" class="avatar w-10 h-10 flex border-2 border-cyan-400 hover:opacity-80 transition cursor-pointer">
               <span class="avatar-initials text-xs">SA</span>
            </button>
            <div id="profile-menu" class="absolute right-0 top-16 w-64 bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-100 dark:border-slate-800 hidden py-2 z-50 dropdown-animate overflow-hidden">
                <div class="px-5 py-5 bg-slate-50 dark:bg-slate-800/50">
                    <p class="text-xs font-black dark:text-white admin-name-display">System Admin</p>
                    <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest">ID: ADM-7721-OP</p>
                </div>
                <div class="p-2">
                    <button onclick="navigate('admin-profile')" class="w-full text-left px-4 py-3 text-xs hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition dark:text-slate-300 flex items-center gap-3">
                        <i class="ph ph-user-gear text-lg text-cyan-500"></i> Account Settings
                    </button>
                    <button onclick="navigate('admin-security')" class="w-full text-left px-4 py-3 text-xs hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition dark:text-slate-300 flex items-center gap-3">
                        <i class="ph ph-fingerprint text-lg text-cyan-500"></i> Security Logs
                    </button>
                    <div class="h-px bg-slate-100 dark:bg-slate-800 my-2"></div>
                    <button onclick="logout()" class="w-full text-left px-4 py-3 text-xs text-red-500 font-black hover:bg-red-50 dark:hover:bg-red-950/20 rounded-xl transition flex items-center gap-3">
                        <i class="ph ph-power text-lg"></i> Terminate Session
                    </button>
                </div>
            </div>
          </div>
       </div>
    </header>

    <!-- CONTENT WRAPPER -->
    <div class="p-8">
        
        <!-- 1. DASHBOARD / LIVE MAP -->
        <section id="view-dashboard" class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center text-cyan-500">
                        <i class="ph ph-users-three text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Fleet Active</p>
                        <p class="text-2xl font-black dark:text-white">1,242</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-green-500/10 flex items-center justify-center text-green-500">
                        <i class="ph ph-moped text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Live Orders</p>
                        <p class="text-2xl font-black dark:text-white">486</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center text-orange-500">
                        <i class="ph ph-clock-countdown text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Avg ETA</p>
                        <p class="text-2xl font-black dark:text-white">12.4m</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-red-500/10 flex items-center justify-center text-red-500">
                        <i class="ph ph-warning-diamond text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Critical Alerts</p>
                        <p class="text-2xl font-black dark:text-white">03</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-8">
                <!-- Fleet Feed -->
                <div class="col-span-12 lg:col-span-4 flex flex-col h-[650px] bg-white dark:bg-slate-900 rounded-3xl border dark:border-slate-800 overflow-hidden shadow-premium">
                    <div class="p-6 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30">
                        <div>
                            <h3 class="font-extrabold dark:text-white">Dispatch Feed</h3>
                            <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-0.5">Live Partner Updates</p>
                        </div>
                        <div class="relative">
                            <button onclick="toggleDispatchFilter()" class="p-2 rounded-lg bg-white dark:bg-slate-800 shadow-sm text-slate-400 hover:text-cyan-500 transition">
                                <i class="ph ph-funnel"></i>
                            </button>
                            <!-- Updated Filter Dropdown -->
                            <div id="dispatch-filter-menu" class="absolute right-0 top-12 w-40 bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-100 dark:border-slate-800 hidden z-50 p-2 dropdown-animate">
                                <button onclick="setDispatchFilter('All')" class="w-full text-left px-3 py-2 text-xs rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 font-bold dark:text-white transition">All Activity</button>
                                <button onclick="setDispatchFilter('active')" class="w-full text-left px-3 py-2 text-xs rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-green-500 transition">Active</button>
                                <button onclick="setDispatchFilter('transit')" class="w-full text-left px-3 py-2 text-xs rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-cyan-500 transition">In-Transit</button>
                                <button onclick="setDispatchFilter('alert')" class="w-full text-left px-3 py-2 text-xs rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-red-500 transition">Alerts</button>
                            </div>
                        </div>
                    </div>
                    <div id="control-desk-list" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3"></div>
                </div>

                <!-- Interactive Map -->
                <div class="col-span-12 lg:col-span-8 relative h-[650px] group">
                    <div class="absolute top-6 left-6 z-10 w-80">
                         <div class="relative">
                             <i class="ph ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                             <input type="text" id="map-search" placeholder="Search partner, order or area..." class="w-full bg-white/95 dark:bg-slate-900/95 backdrop-blur-md pl-12 pr-4 py-3.5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-2xl text-xs outline-none focus:border-cyan-400 transition" onkeyup="handleMapSearch(event)">
                         </div>
                    </div>

                    <div class="absolute top-6 right-6 z-10 flex flex-col gap-2">
                        <div class="bg-white/95 dark:bg-slate-900/95 backdrop-blur-md p-4 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-2xl">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3">Map Legend</p>
                            <div class="space-y-2">
                                <div class="flex items-center gap-3">
                                    <span class="w-3 h-3 rounded-full bg-green-500 shadow-lg shadow-green-500/20"></span>
                                    <span class="text-[10px] font-bold dark:text-slate-300">Available</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="w-3 h-3 rounded-full bg-cyan-400 shadow-lg shadow-cyan-400/20"></span>
                                    <span class="text-[10px] font-bold dark:text-slate-300">In-Transit</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="w-3 h-3 rounded-full bg-red-500 animate-pulse shadow-lg shadow-red-500/20"></span>
                                    <span class="text-[10px] font-bold dark:text-slate-300">Emergency</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="live-map" class="bg-slate-200 dark:bg-slate-800 rounded-3xl border-4 border-white dark:border-slate-900 shadow-premium overflow-hidden h-full"></div>
                </div>
            </div>
        </section>

        <!-- 2. OPERATIONS CONSOLE (RAPIDO STYLE) -->
        <section id="view-orders" class="hidden space-y-8 animate-fade-in">
            <div class="flex flex-col xl:flex-row gap-6 justify-between items-start xl:items-center">
                <div class="flex flex-col gap-4">
                    <h2 class="text-2xl font-extrabold tracking-tight dark:text-white">Operational Console</h2>
                    <div class="relative flex bg-slate-200/50 dark:bg-slate-800/50 p-1.5 rounded-2xl w-fit backdrop-blur-sm border border-slate-200 dark:border-slate-800">
                        <!-- Active Glider -->
                        <div id="tab-glider" class="absolute h-[calc(100%-12px)] top-1.5 left-1.5 bg-white dark:bg-slate-700 rounded-xl shadow-lg transition-all duration-300 ease-out z-0"></div>
                        
                        <button id="tab-unassigned" class="order-tab relative z-10 px-8 py-3 rounded-xl text-xs font-black transition-colors" onclick="setOrderFilter('Unassigned')">Unassigned <span class="ml-2 opacity-50">04</span></button>
                        <button id="tab-inprogress" class="order-tab relative z-10 px-8 py-3 rounded-xl text-xs font-black transition-colors" onclick="setOrderFilter('In Progress')">Live Tracking <span class="ml-2 opacity-50">82</span></button>
                        <button id="tab-completed" class="order-tab relative z-10 px-8 py-3 rounded-xl text-xs font-black transition-colors" onclick="setOrderFilter('Completed')">History <span class="ml-2 opacity-50">1.2k</span></button>
                    </div>
                </div>

                <div class="flex items-center gap-4 w-full xl:w-auto">
                    <div class="relative flex-1 xl:w-96">
                        <i class="ph ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="order-search" placeholder="Search by Order ID, Partner, Area..." class="w-full bg-white dark:bg-slate-900 pl-12 pr-4 py-3.5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm text-xs outline-none focus:border-cyan-400 transition" onkeyup="renderDispatch()">
                    </div>
                    <button class="p-3.5 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm text-slate-500">
                        <i class="ph ph-export text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Dashboard Stats Summary for Dispatcher -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                 <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border dark:border-slate-800 flex justify-between items-center">
                     <div>
                         <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">SLA Compliance</p>
                         <p class="text-lg font-black dark:text-white">98.2%</p>
                     </div>
                     <span class="text-[10px] font-bold text-green-500">+0.4%</span>
                 </div>
                 <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border dark:border-slate-800 flex justify-between items-center">
                     <div>
                         <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Late Deliveries</p>
                         <p class="text-lg font-black text-red-500">02</p>
                     </div>
                     <i class="ph ph-clock-user text-slate-200 text-xl"></i>
                 </div>
                 <div class="bg-white dark:bg-slate-900 p-4 rounded-2xl border dark:border-slate-800 flex justify-between items-center">
                     <div>
                         <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Rush Orders</p>
                         <p class="text-lg font-black dark:text-white">14</p>
                     </div>
                     <i class="ph ph-fire text-orange-500 text-xl"></i>
                 </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-6" id="orders-list">
                <!-- Advanced Cards Rendered Here -->
            </div>
        </section>
        
        <!-- NEW SECTION: INCENTIVE ENGINE -->
        <section id="view-incentives" class="hidden space-y-8 animate-fade-in">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-extrabold tracking-tight dark:text-white">Incentive Engine & Targets</h2>
                    <p class="text-slate-500 text-xs mt-1">Configure automated rewards for partner performance</p>
                </div>
                <button onclick="openCreateIncentiveModal()" class="bg-black text-brand-gold dark:bg-brand-gold dark:text-black px-6 py-3 rounded-xl font-bold text-xs uppercase tracking-wider flex items-center gap-2 shadow-lg hover:scale-105 transition">
                    <i class="ph ph-plus-circle text-lg"></i> Create New Target
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Active Rules Summary -->
                <div class="bg-gradient-to-br from-brand-gold to-orange-400 p-6 rounded-3xl text-black shadow-lg shadow-orange-500/20">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-black uppercase tracking-widest opacity-70">Active Campaigns</p>
                            <p class="text-3xl font-black mt-1" id="active-campaigns-count">02</p>
                        </div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                            <i class="ph ph-megaphone text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-8">
                        <p class="text-xs font-bold">Top Performer: <span class="opacity-70">Senthil Kumar (28 orders)</span></p>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Incentives Paid Today</p>
                            <p class="text-3xl font-black dark:text-white mt-1">₹3,480</p>
                        </div>
                        <div class="w-10 h-10 bg-green-500/10 text-green-500 rounded-xl flex items-center justify-center">
                            <i class="ph ph-money text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-8 flex items-center gap-2 text-green-500 text-xs font-bold">
                        <i class="ph ph-trend-up"></i> 12% increase in productivity
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col justify-center items-center text-center">
                     <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2">System Status</p>
                     <div class="flex items-center gap-2 bg-green-500/10 text-green-600 px-4 py-2 rounded-full">
                         <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                         <span class="text-xs font-bold">Auto-Credit Active</span>
                     </div>
                     <p class="text-[10px] text-slate-400 mt-2">Payouts trigger instantly on target hit</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Rule Configuration List -->
                <div class="lg:col-span-1 space-y-4">
                    <h3 class="text-sm font-black dark:text-white uppercase tracking-wider mb-2">Active Targets</h3>
                    <div id="incentive-rules-list" class="space-y-4">
                        <!-- Rules injected via JS -->
                    </div>
                </div>

                <!-- Live Progress -->
                <div class="lg:col-span-2 bg-white dark:bg-slate-900 rounded-3xl border dark:border-slate-800 p-6 shadow-premium h-fit">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-black dark:text-white uppercase tracking-wider">Live Driver Progress</h3>
                        <div class="flex gap-2">
                             <button onclick="simulateDriverDay()" class="text-[10px] bg-slate-100 dark:bg-slate-800 px-3 py-1.5 rounded-lg font-bold hover:bg-slate-200 transition dark:text-white">Simulate Activity</button>
                        </div>
                    </div>
                    
                    <div class="space-y-6 max-h-[500px] overflow-y-auto custom-scrollbar pr-2" id="incentive-progress-list">
                        <!-- Progress bars injected via JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. ROSTER / PARTNER LIST -->
        <section id="view-roster" class="hidden space-y-6">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-extrabold tracking-tight dark:text-white">Fleet Directory</h2>
                    <p class="text-slate-500 text-xs mt-1">Managing 450+ Active Logistics Partners</p>
                </div>
                
            </div>
            
            <div class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 overflow-hidden shadow-premium">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 dark:bg-slate-800/50 border-b dark:border-slate-800 text-[10px] uppercase font-black text-slate-500 tracking-[0.15em]">
                        <tr>
                            <th class="px-8 py-5">Partner Identity</th>
                            <th class="px-8 py-5">Classification</th>
                            <th class="px-8 py-5">Network Status</th>
                            <th class="px-8 py-5">Ratings</th>
                            <th class="px-8 py-5 text-right">Operations</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-800" id="roster-table"></tbody>
                </table>
            </div>
        </section>

        <!-- 4. KYC APPROVALS -->
        <section id="view-profile" class="hidden space-y-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-extrabold tracking-tight dark:text-white">KYC Compliance Queue</h2>
                    <p class="text-slate-500 text-xs mt-1">Verifying identity and skill certifications</p>
                </div>
                <div class="flex gap-2">
                    <span class="bg-red-500/10 text-red-500 text-[10px] font-black px-3 py-1.5 rounded-lg uppercase tracking-wider border border-red-500/20">12 Pending Review</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="kyc-list"></div>
        </section>

        <!-- 5. EARNINGS & PAYOUTS -->
        <section id="view-earnings" class="hidden space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border dark:border-slate-800 shadow-sm relative overflow-hidden group">
                    <div class="absolute -bottom-4 -right-4 text-cyan-400/5 text-8xl transition-transform group-hover:scale-110">
                        <i class="ph ph-currency-inr"></i>
                    </div>
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Net Revenue (Admin)</p>
                    <p class="text-4xl font-black mt-2 dark:text-white">₹72,435</p>
                    <div class="flex items-center gap-2 mt-4 text-xs font-bold text-green-500">
                        <i class="ph ph-trend-up"></i> +12.4% vs prev week
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border dark:border-slate-800 shadow-sm relative overflow-hidden group">
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Partner Payouts Due</p>
                    <p class="text-4xl font-black mt-2 text-orange-500">₹1,12,040</p>
                    <p class="text-[10px] text-slate-400 font-bold mt-4">14 Pending Batch Requests</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border dark:border-slate-800 shadow-sm relative overflow-hidden group">
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Platform Fees</p>
                    <p class="text-4xl font-black mt-2 dark:text-white">₹24,145</p>
                    <p class="text-xs text-blue-500 font-bold mt-4">Calculated @ 15% Platform Margin</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white dark:bg-slate-900 p-8 rounded-3xl border dark:border-slate-800 shadow-premium">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-lg font-extrabold dark:text-white">Transaction Ledger</h3>
                        <button class="text-xs text-cyan-500 font-black uppercase tracking-widest hover:underline">View All Records</button>
                    </div>
                    <div id="payout-history" class="space-y-4"></div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border dark:border-slate-800 shadow-premium">
                    <h3 class="text-lg font-extrabold mb-6 dark:text-white">Revenue Analysis</h3>
                    <div class="h-[300px]"><canvas id="chart-earnings"></canvas></div>
                </div>
            </div>
        </section>

        <!-- 6. HELP CENTER / TICKETS -->
        <section id="view-support" class="hidden space-y-6">
            <div class="flex items-end justify-between">
                <div>
                    <h2 class="text-2xl font-extrabold tracking-tight dark:text-white">Support Console</h2>
                    <p class="text-slate-500 text-xs mt-1">Real-time resolution desk for partners and users</p>
                </div>
            </div>
            <div id="ticket-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </section>

        <!-- 7. ADMIN PROFILE -->
        <section id="view-admin-profile" class="hidden max-w-2xl mx-auto py-10">
            <div class="bg-white dark:bg-slate-900 p-10 rounded-3xl border dark:border-slate-800 shadow-2xl">
                <div class="flex items-center gap-6 mb-10 pb-10 border-b dark:border-slate-800">
                     <div class="avatar w-20 h-20 text-2xl font-black">
                         <span class="avatar-initials">SA</span>
                     </div>
                     <div>
                         <h2 class="text-2xl font-extrabold dark:text-white">Update Profile</h2>
                         <p class="text-slate-500 text-sm">System Admin • Master Account</p>
                     </div>
                </div>
                
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="text-[10px] uppercase font-black text-slate-400 tracking-widest mb-2 block">Display Name</label>
                            <input type="text" id="admin-name-input" class="input-field dark:bg-slate-800 dark:border-slate-700 dark:text-white" value="System Admin">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-black text-slate-400 tracking-widest mb-2 block">Employee ID</label>
                            <input type="text" readonly class="input-field bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 text-slate-400 cursor-not-allowed" value="ADM-7721-OP">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-black text-slate-400 tracking-widest mb-2 block">Direct Email</label>
                        <input type="email" id="admin-email-input" class="input-field dark:bg-slate-800 dark:border-slate-700 dark:text-white" value="admin@dechta.com">
                    </div>
                    <div class="pt-6">
                        <button onclick="saveProfile()" class="w-full bg-black text-cyan-400 dark:bg-cyan-400 dark:text-black py-4 rounded-2xl font-black text-sm hover:shadow-2xl transition shadow-cyan-400/20">Confirm Changes</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. SECURITY -->
        <section id="view-admin-security" class="hidden max-w-2xl mx-auto py-10">
            <div class="bg-white dark:bg-slate-900 p-10 rounded-3xl border dark:border-slate-800 shadow-2xl">
                <h2 class="text-2xl font-extrabold mb-8 dark:text-white flex items-center gap-3">
                    <i class="ph ph-lock-key text-cyan-400"></i> Security Credentials
                </h2>
                <div class="space-y-8">
                    <div class="bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                        <h3 class="text-xs font-black uppercase tracking-widest text-slate-500 mb-4">Rotation Policy</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400">Your master passcode was last changed 14 days ago. Next rotation due in 16 days.</p>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <label class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">Current Authorization Key</label>
                            <input type="password" class="input-field dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="••••••••">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">New Key</label>
                                <input type="password" class="input-field dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="••••••••">
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">Repeat New Key</label>
                                <input type="password" class="input-field dark:bg-slate-800 dark:border-slate-700 dark:text-white" placeholder="••••••••">
                            </div>
                        </div>
                    </div>
                    <button onclick="saveSecurity()" class="w-full bg-black text-cyan-400 py-4 rounded-2xl font-black text-sm shadow-xl">Apply New Protocol</button>
                </div>
            </div>
        </section>
    </div>
  </main>
</div>

<script>
    let currentView = 'dashboard';
    let currentOrderFilter = 'Unassigned';
    let currentDispatchFilter = 'All'; // New filter state for map/feed
    let map;
    let mapMarkers = [];
    let earningsChart;
    let isDarkMode = false;

    // --- MOCK DATABASE ---
    // Added daily/weekly/wallet properties to support Incentives
    // Added bank details
   let drivers = [
    { name: 'Senthil Kumar', id: 'DR-9921', vehicle: 'Truck (E-Carrier)', status: 'Online', lastKnownStatus: 'Online', rating: 4.8, trips: 1420, dailyOrders: 22, weeklyOrders: 145, wallet: 1200, bank: { name: 'HDFC Bank', acc: '**** 8821', ifsc: 'HDFC0004512' } },
    { name: 'Priya Raj', id: 'DR-8801', vehicle: 'Electrician (Tech)', status: 'Offline', lastKnownStatus: 'Offline', rating: 4.9, trips: 856, dailyOrders: 5, weeklyOrders: 80, wallet: 4500, bank: { name: 'ICICI Bank', acc: '**** 1244', ifsc: 'ICIC0001122' } },
    { name: 'Vikram Singh', id: 'DR-7712', vehicle: 'Mason / Labor', status: 'Online', lastKnownStatus: 'Online', rating: 4.7, trips: 2102, dailyOrders: 18, weeklyOrders: 110, wallet: 800, bank: { name: 'SBI', acc: '**** 7712', ifsc: 'SBIN0006789' } },
    { name: 'Rahul Sharma', id: 'DR-4421', vehicle: 'Bike Taxi', status: 'Online', lastKnownStatus: 'Online', rating: 4.6, trips: 450, dailyOrders: 26, weeklyOrders: 152, wallet: 320, bank: { name: 'Axis Bank', acc: '**** 9901', ifsc: 'UTIB0002233' } },
    { name: 'Arjun Das', id: 'DR-3301', vehicle: 'Pickup Van', status: 'Online', lastKnownStatus: 'Online', rating: 4.5, trips: 920, dailyOrders: 10, weeklyOrders: 60, wallet: 1500, bank: { name: 'HDFC Bank', acc: '**** 3301', ifsc: 'HDFC0001234' } },
    { name: 'Meera Iyer', id: 'DR-2210', vehicle: 'E-Bike', status: 'Offline', lastKnownStatus: 'Offline', rating: 4.9, trips: 110, dailyOrders: 2, weeklyOrders: 15, wallet: 200, bank: { name: 'Kotak Bank', acc: '**** 5566', ifsc: 'KKBK0009988' } },
    { name: 'Karthik Raja', id: 'DR-1144', vehicle: 'Heavy Loader', status: 'Online', lastKnownStatus: 'Online', rating: 4.2, trips: 540, dailyOrders: 15, weeklyOrders: 90, wallet: 600, bank: { name: 'Indian Bank', acc: '**** 1144', ifsc: 'IDIB0005544' } },
    { name: 'Sneha Rao', id: 'DR-5566', vehicle: 'Electrician', status: 'Online', lastKnownStatus: 'Online', rating: 4.7, trips: 330, dailyOrders: 8, weeklyOrders: 40, wallet: 900, bank: { name: 'Canara Bank', acc: '**** 2211', ifsc: 'CNRB0003344' } }
];

    let incentiveRules = [
        { id: 1, title: 'Daily Hustle', target: 25, period: 'Daily', amount: 80, active: true, icon: 'sun' },
        { id: 2, title: 'Weekly Warrior', target: 150, period: 'Weekly', amount: 80, active: true, icon: 'calendar' }
    ];

    let ordersData = [
    { id: 'TID-8821', type: 'Construction Material', from: 'Anna Nagar West', to: 'Velachery Central', driver: 'Senthil Kumar', status: 'In Progress', priority: 'High', price: '₹1,240', distance: '12.4km', eta: '18 min', phone: '+919876543210' },
    { id: 'TID-8822', type: 'Emergency Plumbing', from: 'T-Nagar Market', to: 'Mylapore Coast', driver: 'Pending', status: 'Unassigned', priority: 'Urgent', price: '₹450', distance: '4.2km', eta: '--', phone: '000' },
    { id: 'TID-9902', type: 'Electrical Installation', from: 'Central Station', to: 'Egmore Heights', driver: 'Arjun Das', status: 'In Progress', priority: 'Normal', price: '₹890', distance: '6.5km', eta: '5 min', phone: '+919988776655' },
    { id: 'TID-1120', type: 'Heavy Masonry', from: 'Mylapore Temple', to: 'Chennai Airport', driver: 'Vikram Singh', status: 'Completed', priority: 'High', price: '₹2,500', distance: '18.2km', eta: 'Done', phone: '+918877665544' },
    { id: 'TID-4451', type: 'Pantry Delivery', from: 'Adyar Office', to: 'Oaks Mall Park', driver: 'Sneha Rao', status: 'Completed', priority: 'Normal', price: '₹120', distance: '2.1km', eta: 'Done', phone: '+917766554433' },
    { id: 'TID-7731', type: 'Cement Transport', from: 'Guindy Ind.', to: 'Tambaram East', driver: 'Pending', status: 'Unassigned', priority: 'High', price: '₹3,200', distance: '15.0km', eta: '--', phone: '000' }
];

    let notifications = [
        { id: 1, type: 'registration', title: 'Compliance Alert', body: 'Rahul M. uploaded documents for manual review.', time: '2m ago' },
        { id: 2, type: 'emergency', title: 'SOS Notification', body: 'Partner DR-4421 reported a breakdown near T-Nagar.', time: '5m ago' },
        { id: 3, type: 'payout', title: 'Payout Processed', body: '₹1,24,000 settled for Weekly Batch #42.', time: '1h ago' },
    ];

    const mockLocations = [
    { id: 'DR-9921', name: 'Senthil Kumar', lat: 13.0418, lng: 80.2341, status: 'transit', task: 'TID-8821 Construction', battery: '82%', speed: '32km/h' },
    { id: 'DR-7712', name: 'Vikram Singh', lat: 13.0850, lng: 80.2101, status: 'active', task: 'Site #102 Masonry', battery: '45%', speed: 'Idling' },
    { id: 'DR-4421', name: 'Rahul Sharma', lat: 13.0012, lng: 80.2565, status: 'active', task: 'Order #442 Delivery', battery: '12%', speed: '12km/h' },
    { id: 'DR-1022', name: 'Kiran Deep', lat: 13.0475, lng: 80.2824, status: 'idle', task: 'Awaiting Order', battery: '95%', speed: 'Stopped' }
];

    // --- DISPATCH FILTER LOGIC ---
    function toggleDispatchFilter() {
        document.getElementById('dispatch-filter-menu').classList.toggle('hidden');
    }

    function setDispatchFilter(status) {
        currentDispatchFilter = status;
        document.getElementById('dispatch-filter-menu').classList.add('hidden');
        renderControlDesk(); // Refresh list based on new filter
    }

    // --- DASHBOARD: CONTROL DESK RENDERER ---
    function renderControlDesk() {
        const container = document.getElementById('control-desk-list');
        if (!container) return;

        // Apply filtering logic
        let filteredLocations = mockLocations;
        if (currentDispatchFilter !== 'All') {
            filteredLocations = mockLocations.filter(loc => loc.status === currentDispatchFilter);
        }

        if (filteredLocations.length === 0) {
            container.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs font-bold uppercase tracking-widest">No partners found for filter: ${currentDispatchFilter}</div>`;
            return;
        }

        container.innerHTML = filteredLocations.map(loc => {
            const statusColor = {
                'active': 'text-green-500',
                'transit': 'text-cyan-500',
                'alert': 'text-red-500',
                'idle': 'text-slate-400',
                'break': 'text-orange-500'
            }[loc.status];

            const batteryIcon = parseInt(loc.battery) < 20 ? 'ph-battery-warning text-red-500' : 'ph-battery-high';

            return `
                <div onclick="focusOnPartner('${loc.id}')" class="p-4 bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700/50 card-hover shadow-sm flex flex-col gap-3 group">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-current ${statusColor}"></span>
                            <span class="text-[10px] font-black uppercase tracking-widest ${statusColor}">${loc.status}</span>
                        </div>
                        <div class="flex items-center gap-1.5 text-[10px] font-bold text-slate-400">
                            <i class="ph ${batteryIcon}"></i> ${loc.battery}
                        </div>
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="font-extrabold text-sm dark:text-white">${loc.name}</p>
                            <p class="text-[10px] text-slate-500 font-bold">${loc.task}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">${loc.id}</div>
                            <div class="text-[9px] font-bold text-cyan-500 bg-cyan-500/10 px-1.5 py-0.5 rounded">${loc.speed}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function focusOnPartner(id) {
        const found = mapMarkers.find(m => m.id === id.toLowerCase());
        if (found) {
            map.flyTo(found.marker.getLatLng(), 16, { duration: 1.5 });
            found.marker.openPopup();
        }
    }

    // --- NOTIFICATION HANDLERS ---
    function toggleNotifications() {
        const panel = document.getElementById('notif-panel');
        const isHidden = panel.classList.toggle('hidden');
        if (!isHidden) {
            document.getElementById('profile-menu').classList.add('hidden');
            document.getElementById('dispatch-filter-menu')?.classList.add('hidden');
            renderNotifications();
        }
    }

    function renderNotifications() {
        const list = document.getElementById('notif-list');
        if (notifications.length === 0) {
            list.innerHTML = `<div class="p-10 text-center text-slate-400 text-xs font-bold uppercase tracking-widest">Inbox Zero</div>`;
            return;
        }
        list.innerHTML = notifications.map(n => `
            <div class="px-6 py-4 hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b dark:border-slate-800 last:border-0 cursor-pointer group">
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 rounded-xl flex-shrink-0 flex items-center justify-center ${n.type === 'emergency' ? 'bg-red-500/10 text-red-500' : 'bg-cyan-500/10 text-cyan-600'}">
                        <i class="ph ph-${n.type === 'emergency' ? 'warning-circle' : 'bell-ringing'} text-xl"></i>
                    </div>
                    <div>
                        <p class="text-xs font-black dark:text-white">${n.title}</p>
                        <p class="text-[11px] text-slate-500 mt-1 leading-relaxed">${n.body}</p>
                        <p class="text-[9px] text-slate-400 mt-2 uppercase font-black tracking-widest">${n.time}</p>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function clearNotifs() {
        notifications = [];
        renderNotifications();
    }

    // --- PROFILE HANDLERS ---
    function toggleProfileMenu() {
        const menu = document.getElementById('profile-menu');
        const isHidden = menu.classList.toggle('hidden');
        if (!isHidden) {
            document.getElementById('notif-panel').classList.add('hidden');
            document.getElementById('dispatch-filter-menu')?.classList.add('hidden');
        }
    }

    function saveProfile() {
        const newName = document.getElementById('admin-name-input').value;
        if (!newName) return;
        document.querySelectorAll('.admin-name-display').forEach(el => el.innerText = newName);
        navigate('dashboard');
    }

    function saveSecurity() { navigate('dashboard'); }

    window.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown-container') && !e.target.closest('.relative')) {
            document.getElementById('notif-panel')?.classList.add('hidden');
            document.getElementById('profile-menu')?.classList.add('hidden');
            document.getElementById('dispatch-filter-menu')?.classList.add('hidden');
        }
    });

    // --- MODAL CONTROLS ---
    function showModal(content) {
        document.getElementById('modal-body').innerHTML = content;
        document.getElementById('global-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('global-modal').classList.add('hidden');
    }

    // --- OPERATIONAL CONSOLE: FILTER & RENDER ---
    function setOrderFilter(filter) {
        currentOrderFilter = filter;
        updateTabGlider();
        renderDispatch();
    }

    function updateTabGlider() {
        const activeTab = document.getElementById(`tab-${currentOrderFilter.toLowerCase().replace(' ', '')}`);
        const glider = document.getElementById('tab-glider');
        if (activeTab && glider) {
            glider.style.width = `${activeTab.offsetWidth}px`;
            glider.style.left = `${activeTab.offsetLeft}px`;
            
            document.querySelectorAll('.order-tab').forEach(tab => {
                tab.classList.remove('text-black', 'dark:text-white');
                tab.classList.add('text-slate-500');
            });
            activeTab.classList.add('text-black', 'dark:text-white');
            activeTab.classList.remove('text-slate-500');
        }
    }

    function renderDispatch() {
    const container = document.getElementById('orders-list');
    const query = document.getElementById('order-search').value.toLowerCase();
    
    // Filters data based on the current tab (Unassigned, In Progress, Completed)
    const filtered = ordersData.filter(o => {
        const matchesStatus = o.status === currentOrderFilter;
        const matchesSearch = o.id.toLowerCase().includes(query) || o.from.toLowerCase().includes(query) || o.to.toLowerCase().includes(query) || o.driver.toLowerCase().includes(query);
        return matchesStatus && matchesSearch;
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="col-span-full py-20 text-center"><p class="text-slate-400 font-black uppercase tracking-widest text-xs">No matching orders in ${currentOrderFilter} queue</p></div>`;
        return;
    }

    container.innerHTML = filtered.map(o => {
        const priorityStyle = {
            'Urgent': 'bg-red-500 text-white',
            'High': 'bg-orange-500 text-white',
            'Normal': 'bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400'
        }[o.priority];

        const isUnassigned = o.status === 'Unassigned';

        return `
            <div class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 p-6 shadow-premium card-hover group flex flex-col h-full animate-fade-in">
                <div class="flex justify-between items-start mb-5">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${o.id}</span>
                        <span class="text-sm font-extrabold dark:text-white mt-1">${o.type}</span>
                    </div>
                    <span class="${priorityStyle} text-[9px] px-2.5 py-1 rounded-lg font-black uppercase tracking-wider">${o.priority}</span>
                </div>

                <div class="space-y-1 relative mb-6">
                    <div class="flex items-start gap-4">
                        <div class="mt-1 w-3 h-3 rounded-full border-2 border-cyan-400 bg-white dark:bg-slate-900 z-10"></div>
                        <div class="flex flex-col">
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Pickup</span>
                            <span class="text-xs font-extrabold dark:text-slate-200">${o.from}</span>
                        </div>
                    </div>
                    <div class="route-line"></div>
                    <div class="flex items-start gap-4">
                        <i class="ph ph-map-pin-fill text-red-500 text-sm z-10"></i>
                        <div class="flex flex-col">
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Destination</span>
                            <span class="text-xs font-extrabold dark:text-slate-200">${o.to}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl flex justify-between items-center mb-6">
                    <div>
                        <p class="text-[9px] text-slate-400 font-black uppercase tracking-widest">Partner Assigned</p>
                        <div class="flex items-center gap-2 mt-1">
                            ${isUnassigned ? 
                                `<span class="text-[11px] font-black dark:text-white text-slate-500 italic">Pending Assignment</span>` : 
                                `<div class="w-6 h-6 rounded-full bg-cyan-400/20 flex items-center justify-center text-[10px] font-bold text-cyan-500">
                                    ${o.driver[0]}
                                </div>
                                <span class="text-[11px] font-black dark:text-white">${o.driver}</span>`
                            }
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] text-slate-400 font-black uppercase tracking-widest">Net Value</p>
                        <p class="text-sm font-black dark:text-white mt-1">${o.price}</p>
                    </div>
                </div>

                <div class="mt-auto">
                    <div class="flex items-center justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">
                        <span class="flex items-center gap-1.5"><i class="ph ph-path"></i> ${o.distance}</span>
                        <span class="flex items-center gap-1.5 text-cyan-500"><i class="ph ph-timer"></i> ETA: ${o.eta}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        ${isUnassigned ? 
                            `<button onclick="openAssignModal('${o.id}')" class="col-span-2 py-3 bg-black text-white dark:bg-white dark:text-black rounded-xl text-[10px] font-black uppercase tracking-widest hover:scale-[1.02] transition shadow-lg">Assign Logistics Partner</button>` :
                            `<a href="tel:${o.phone || '+910000000000'}" class="py-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-[10px] font-black uppercase tracking-widest text-center transition hover:bg-slate-200 dark:hover:bg-slate-700 dark:text-slate-300">
                                Call Partner
                            </a>
                            <button class="py-3 bg-black text-cyan-400 dark:bg-cyan-400 dark:text-black rounded-xl text-[10px] font-black uppercase tracking-widest transition hover:scale-[1.03]" onclick="handleOrderTrack('${o.driver}')">Track Live</button>`
                        }
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

    // --- NAVIGATION LOGIC ---
    function navigate(view) {
        currentView = view;
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('bg-cyan-400/10', 'text-cyan-400', 'shadow-inner'));

        const target = document.getElementById(`view-${view}`);
        if (target) target.classList.remove('hidden');

        const sideBtn = document.getElementById(`side-${view}`);
        if (sideBtn) sideBtn.classList.add('bg-cyan-400/10', 'text-cyan-400');

        document.getElementById('view-title').innerText = {
            'dashboard': 'Live Control Tower', 'orders': 'Operations Console', 'roster': 'Fleet Management',
            'profile': 'Compliance Queue', 'earnings': 'Platform Economics', 'support': 'Resolution Center',
            'admin-profile': 'Account Master', 'admin-security': 'Security Protocols', 'incentives': 'Incentive Engine'
        }[view];

        if (view === 'dashboard') { setTimeout(() => { initMap(); renderControlDesk(); }, 200); }
        if (view === 'orders') { setTimeout(updateTabGlider, 100); renderDispatch(); }
        if (view === 'roster') renderRoster();
        if (view === 'profile') renderKYC();
        if (view === 'earnings') { initEarningsChart(); renderPayouts(); }
        if (view === 'support') renderTickets();
        if (view === 'incentives') renderIncentives();
    }

    // --- NEW: INCENTIVE ENGINE LOGIC ---
    function renderIncentives() {
        document.getElementById('active-campaigns-count').innerText = incentiveRules.length.toString().padStart(2, '0');
        
        // Render Rules
        const rulesContainer = document.getElementById('incentive-rules-list');
        rulesContainer.innerHTML = incentiveRules.map(rule => `
            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700 flex justify-between items-center group cursor-pointer hover:border-brand-gold transition">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-orange-100 dark:bg-slate-700 flex items-center justify-center text-orange-500 dark:text-white">
                        <i class="ph ph-${rule.icon} text-lg"></i>
                    </div>
                    <div>
                         <p class="text-xs font-black dark:text-white">${rule.title}</p>
                         <p class="text-[10px] text-slate-500 font-bold">Target: ${rule.target} orders/${rule.period.toLowerCase()}</p>
                    </div>
                </div>
                <div class="text-right flex items-center gap-3">
                    <div>
                        <p class="text-sm font-black text-green-500">₹${rule.amount}</p>
                        <p class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Reward</p>
                    </div>
                    
                    <div class="flex gap-2 ml-2 pl-4 border-l dark:border-slate-700">
                        <button onclick="editIncentive(${rule.id})" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-slate-400 hover:text-blue-500 transition" title="Edit Campaign">
                            <i class="ph ph-pencil-simple text-lg"></i>
                        </button>
                        <button onclick="deleteIncentive(${rule.id})" class="p-1.5 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-slate-400 hover:text-red-500 transition" title="Delete Campaign">
                            <i class="ph ph-trash text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        // Render Progress
        renderIncentiveProgress();
    }
    
    function deleteIncentive(id) {
        if(confirm('Are you sure you want to permanently delete this incentive campaign?')) {
            incentiveRules = incentiveRules.filter(r => r.id !== id);
            renderIncentives();
        }
    }

    function editIncentive(id) {
        const rule = incentiveRules.find(r => r.id === id);
        if(rule) openCreateIncentiveModal(rule);
    }

    function renderIncentiveProgress() {
        const progressContainer = document.getElementById('incentive-progress-list');
        
        if(incentiveRules.length === 0) {
            progressContainer.innerHTML = '<p class="text-xs text-slate-400 text-center py-4">No active campaigns to track.</p>';
            return;
        }

        // We will just show the first active rule progress for simplicity in this view
        const activeRule = incentiveRules[0]; 

        progressContainer.innerHTML = drivers.map(d => {
            const progress = (d.dailyOrders / activeRule.target) * 100;
            const isCompleted = d.dailyOrders >= activeRule.target;
            
            return `
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700/50">
                    <div class="flex justify-between items-center mb-2">
                         <div class="flex items-center gap-3">
                             <div class="avatar w-8 h-8 text-[10px]"><span>${d.name[0]}</span></div>
                             <div>
                                 <p class="text-xs font-bold dark:text-white">${d.name}</p>
                                 <p class="text-[9px] text-slate-500 font-bold uppercase">${d.id}</p>
                             </div>
                         </div>
                         <div class="text-right">
                             ${isCompleted 
                                ? `<span class="bg-green-500 text-white px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider">Paid ₹${activeRule.amount}</span>`
                                : `<span class="text-xs font-black dark:text-white">${d.dailyOrders} / ${activeRule.target}</span>`
                             }
                         </div>
                    </div>
                    <div class="h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full ${isCompleted ? 'bg-green-500' : 'bg-brand-gold'} progress-bar" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function openCreateIncentiveModal(rule = null) {
        const titleVal = rule ? rule.title : '';
        const targetVal = rule ? rule.target : '';
        const periodVal = rule ? rule.period : 'Daily';
        const amountVal = rule ? rule.amount : 80;
        const btnText = rule ? 'Update Campaign' : 'Launch Campaign';
        const editId = rule ? rule.id : null;

        const content = `
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black dark:text-white">${rule ? 'Edit Target' : 'Create New Target'}</h2>
                    <button onclick="closeModal()" class="text-slate-400"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Campaign Title</label>
                        <input type="text" id="inc-title" class="input-field dark:bg-slate-800 dark:text-white" placeholder="e.g. Monsoon Mania" value="${titleVal}">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Target Orders</label>
                            <input type="number" id="inc-target" class="input-field dark:bg-slate-800 dark:text-white" placeholder="25" value="${targetVal}">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Period</label>
                            <select id="inc-period" class="input-field dark:bg-slate-800 dark:text-white">
                                <option value="Daily" ${periodVal === 'Daily' ? 'selected' : ''}>Daily</option>
                                <option value="Weekly" ${periodVal === 'Weekly' ? 'selected' : ''}>Weekly</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Incentive Amount (₹)</label>
                        <input type="number" id="inc-amount" class="input-field dark:bg-slate-800 dark:text-white" value="${amountVal}">
                        <p class="text-[9px] text-slate-500 mt-1">Amount will be auto-credited to driver wallet upon completion.</p>
                    </div>
                    <button onclick="saveNewIncentive(${editId})" class="w-full bg-black text-brand-gold dark:bg-brand-gold dark:text-black py-4 rounded-2xl font-black text-xs uppercase tracking-widest mt-4">${btnText}</button>
                </div>
            </div>
        `;
        showModal(content);
    }

    function saveNewIncentive(editId = null) {
        const title = document.getElementById('inc-title').value;
        const target = parseInt(document.getElementById('inc-target').value);
        const period = document.getElementById('inc-period').value;
        const amount = parseInt(document.getElementById('inc-amount').value);

        if(title && target && amount) {
            if (editId) {
                // Update existing
                const index = incentiveRules.findIndex(r => r.id === editId);
                if (index !== -1) {
                    incentiveRules[index] = { ...incentiveRules[index], title, target, period, amount };
                }
            } else {
                // Create new
                incentiveRules.push({
                    id: incentiveRules.length + 1,
                    title: title,
                    target: target,
                    period: period,
                    amount: amount,
                    active: true,
                    icon: 'star'
                });
            }
            closeModal();
            renderIncentives();
        }
    }

    function simulateDriverDay() {
        if(incentiveRules.length === 0) return;
        
        // Randomly increase daily orders for drivers to show progress bars moving
        drivers.forEach(d => {
            if(Math.random() > 0.3) {
                d.dailyOrders += Math.floor(Math.random() * 3);
                // Check for auto-credit logic
                const rule = incentiveRules[0]; // Check against first rule
                if(d.dailyOrders >= rule.target && d.dailyOrders - 3 < rule.target) {
                    // Just crossed threshold
                    d.wallet += rule.amount;
                    alert(`System Auto-Credit: ₹${rule.amount} added to ${d.name}'s wallet for hitting daily target!`);
                }
            }
        });
        renderIncentives();
    }
    
    // --- ASSIGNMENT MODAL LOGIC ---
    function openAssignModal(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        // filter available drivers (simple mock filter)
        const availableDrivers = drivers.filter(d => d.status === 'Online'); 

        const listHtml = availableDrivers.map(d => `
            <div class="flex justify-between items-center p-3 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl border border-transparent hover:border-slate-200 dark:hover:border-slate-700 transition cursor-pointer mb-2" onclick="assignDriver('${orderId}', '${d.name}')">
                <div class="flex items-center gap-3">
                    <div class="avatar w-8 h-8 text-[10px]"><span>${d.name[0]}</span></div>
                    <div>
                        <p class="text-xs font-bold dark:text-white">${d.name}</p>
                        <p class="text-[9px] text-slate-500 font-bold">${d.vehicle} • ${d.rating} <i class="ph ph-star-fill text-yellow-500"></i></p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-black text-green-500 uppercase tracking-wider">Recommended</p>
                    <p class="text-[9px] text-slate-400 font-bold">~${Math.floor(Math.random() * 5) + 1}km away</p>
                </div>
            </div>
        `).join('');

        const content = `
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                     <div>
                        <h3 class="text-lg font-black dark:text-white">Assign Partner</h3>
                        <p class="text-xs text-slate-500 font-bold">Select a nearby partner for Order #${orderId}</p>
                     </div>
                     <button onclick="closeModal()" class="text-slate-400"><i class="ph ph-x text-xl"></i></button>
                </div>
                <div class="bg-slate-50 dark:bg-slate-900 rounded-2xl p-2 max-h-[300px] overflow-y-auto custom-scrollbar border dark:border-slate-800">
                    ${listHtml}
                </div>
                <button onclick="closeModal()" class="w-full mt-4 py-3 bg-white border border-slate-200 dark:bg-slate-800 dark:border-slate-700 rounded-xl text-xs font-bold dark:text-white hover:bg-slate-50 dark:hover:bg-slate-700 transition">Cancel Assignment</button>
            </div>
        `;
        showModal(content);
    }
    
    function assignDriver(orderId, driverName) {
        const order = ordersData.find(o => o.id === orderId);
        if(order) {
            order.driver = driverName;
            order.status = 'In Progress'; // Move to In Progress tab
            order.eta = '15 min'; // Mock ETA
            closeModal();
            renderDispatch(); // Re-render current list (order will disappear from Unassigned)
            
            // Show custom toast notification instead of alert
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-10 right-10 bg-black text-white px-6 py-4 rounded-xl shadow-2xl z-[100] flex items-center gap-4 animate-fade-in';
            toast.innerHTML = `<i class="ph ph-check-circle text-green-500 text-xl"></i><div><p class="font-bold text-xs">Assignment Successful</p><p class="text-[10px] text-slate-400">Order ${orderId} assigned to ${driverName}</p></div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    }


    // --- DATA RENDERING FUNCTIONS ---
    function renderRoster() {
    const container = document.getElementById('roster-table');
    container.innerHTML = drivers.map(d => {
        // 1. Logic to determine if the partner is suspended
        const isSuspended = d.status === 'Suspended';
        
        // 2. Apply the red highlight class if suspended, otherwise keep it normal
        const rowClass = isSuspended ? 'row-suspended' : '';

        // 3. Determine the color for the status dot
        const statusDotColor = isSuspended ? 'text-red-500' : (d.status === 'Online' ? 'text-green-500' : 'text-slate-400');

        return `
            <tr class="${rowClass} dark:text-white border-b dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/30 transition">
                <td class="px-8 py-5 flex items-center gap-4">
                   <div class="avatar w-10 h-10 text-[10px] border border-cyan-400/30"><span>${d.name[0]}</span></div>
                   <div>
                        <p class="font-extrabold text-xs dark:text-white">${d.name}</p>
                        <p class="text-[10px] text-slate-400 font-bold mt-0.5">${d.id}</p>
                   </div>
                </td>
                <td class="px-8 py-5 text-xs font-bold text-slate-500">${d.vehicle}</td>
                <td class="px-8 py-5">
                    <span class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest ${statusDotColor}">
                        <span class="w-1.5 h-1.5 rounded-full bg-current"></span> ${d.status}
                    </span>
                </td>
                <td class="px-8 py-5">
                    <div class="flex items-center gap-1">
                        <i class="ph ph-star-fill text-brand-gold text-xs"></i>
                        <span class="text-xs font-black">${d.rating}</span>
                        <span class="text-[9px] text-slate-400 ml-1 font-bold">(${d.trips} jobs)</span>
                    </div>
                </td>
                <td class="px-8 py-5 text-right">
                   <button onclick="openManageDriverModal('${d.id}')" class="text-cyan-500 font-black text-[10px] uppercase tracking-widest hover:underline">Manage</button>
                </td>
            </tr>
        `;
    }).join('');
}

    function renderKYC() {
        const items = [
            { doc: 'Identity Document (Aadhar)', driver: 'Rahul Maran', id: 'KYC-881', date: 'Submitted 12m ago' },
            { doc: 'Electrician License', driver: 'Sunita Pillai', id: 'KYC-209', date: 'Submitted Yesterday' },
            { doc: 'Vehicle RC / Insurance', driver: 'Vikram Singh', id: 'KYC-331', date: 'Urgent Rotation' }
        ];
        document.getElementById('kyc-list').innerHTML = items.map(k => `
            <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl border dark:border-slate-800 shadow-premium card-hover flex flex-col items-start">
                <div class="w-14 h-14 bg-slate-50 dark:bg-slate-800 rounded-2xl flex items-center justify-center text-cyan-500 mb-6 shadow-sm border border-slate-100 dark:border-slate-700">
                    <i class="ph ph-files text-3xl"></i>
                </div>
                <div>
                    <h4 class="font-black text-base dark:text-white">${k.doc}</h4>
                    <p class="text-xs text-slate-500 font-bold mt-1">Provider: ${k.driver}</p>
                    <div class="flex items-center gap-3 mt-4">
                        <span class="text-[10px] bg-cyan-500/10 text-cyan-500 px-2.5 py-1 rounded-lg font-black uppercase tracking-wider">${k.id}</span>
                        <span class="text-[10px] text-slate-400 font-bold">${k.date}</span>
                    </div>
                </div>
                <button class="w-full mt-8 bg-black text-cyan-400 dark:bg-cyan-400 dark:text-black py-4 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] shadow-xl shadow-cyan-500/10" onclick="openKYCReview()">Analyze Documents</button>
            </div>
        `).join('');
    }

    function renderPayouts() {
        const payouts = [
            { id: 'TX-99211', amount: '₹42,000', label: 'Weekly Fleet Settlement', status: 'Success', date: 'Today, 09:45' },
            { id: 'TX-99212', amount: '₹1,250', label: 'On-Demand Payout (Vikram)', status: 'Processing', date: '2h ago' },
            { id: 'TX-99213', amount: '₹145.2', label: 'Platform Comission #TID82', status: 'Success', date: '4h ago' }
        ];
        document.getElementById('payout-history').innerHTML = payouts.map(p => `
            <div class="flex justify-between items-center p-5 bg-slate-50 dark:bg-slate-800/40 rounded-2xl hover:bg-slate-100 transition cursor-pointer group border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                <div class="flex gap-5 items-center">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center bg-white dark:bg-slate-700 text-slate-400 shadow-sm">
                        <i class="ph ph-${p.status==='Success' ? 'check-circle text-green-500' : 'arrows-clockwise animate-spin'} text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-xs font-black dark:text-white">${p.label}</p>
                        <p class="text-[10px] text-slate-400 font-bold mt-1">${p.id} • ${p.date}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm font-black dark:text-white">${p.amount}</p>
                    <p class="text-[9px] ${p.status==='Success' ? 'text-green-500' : 'text-orange-500'} font-black uppercase tracking-[0.15em] mt-1">${p.status}</p>
                </div>
            </div>
        `).join('');
    }

    function renderTickets() {
        const tickets = [
            { title: 'Critical Breakdown: NH-45', body: 'Partner Ramesh (DR-9921) reported engine failure. Alternative needed.', urgent: true, time: '8m ago' },
            { title: 'Payment Dispute (TID-442)', body: 'Customer claims refund for damaged masonry items.', urgent: false, time: '1h ago' }
        ];
        document.getElementById('ticket-list').innerHTML = tickets.map(t => `
            <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border-l-8 shadow-premium flex justify-between items-center ${t.urgent ? 'border-red-500' : 'border-cyan-400'}">
                <div class="flex-1 pr-6">
                    <div class="text-xs font-black dark:text-white flex items-center gap-3">
                        ${t.title} ${t.urgent ? '<span class="text-[9px] bg-red-100 text-red-500 px-2 py-0.5 rounded-lg uppercase">Immediate Action</span>' : ''}
                    </div>
                    <p class="text-xs text-slate-500 mt-2 leading-relaxed font-medium">${t.body}</p>
                    <p class="text-[9px] text-slate-400 font-black uppercase tracking-widest mt-3 italic">${t.time}</p>
                </div>
                <button class="bg-black text-cyan-400 dark:bg-cyan-400 dark:text-black text-[10px] font-black px-6 py-3 rounded-xl uppercase tracking-widest shadow-lg">Investigate</button>
            </div>
        `).join('');
    }

    function initEarningsChart() {
        const ctx = document.getElementById('chart-earnings');
        if(!ctx || earningsChart) return;
        earningsChart = new Chart(ctx, { 
            type: 'doughnut', 
            data: { 
                labels: ['Platform Profit', 'GST / Tax', 'Operational Costs'], 
                datasets: [{ 
                    data: [72, 18, 10], 
                    backgroundColor: ['#0ceded', '#38bdf8', '#0f172a'],
                    borderWidth: 0,
                    hoverOffset: 20
                }] 
            }, 
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { position: 'bottom', labels: { color: isDarkMode ? '#94a3b8' : '#64748b', font: { family: 'Plus Jakarta Sans', weight: 'bold', size: 10 } } } },
                cutout: '75%'
            } 
        });
    }

    function toggleTheme() {
        isDarkMode = !isDarkMode;
        document.documentElement.classList.toggle('dark');
        const icons = document.querySelectorAll('.theme-icon');
        icons.forEach(i => i.classList.replace(isDarkMode ? 'ph-moon' : 'ph-sun', isDarkMode ? 'ph-sun' : 'ph-moon'));
        if (earningsChart) { earningsChart.destroy(); earningsChart = null; if(currentView === 'earnings') initEarningsChart(); }
        if(map) { map.invalidateSize(); }
    }

    function performLogin() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        navigate('dashboard');
    }

    function logout() { location.reload(); }

    // --- MAP CORE ---
    function initMap() {
        if(map) { map.invalidateSize(); return; }
        map = L.map('live-map', { zoomControl: false, attributionControl: false }).setView([13.045, 80.250], 12);
        L.tileLayer(isDarkMode ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        renderMarkers();
    }

    function renderMarkers() {
        mapMarkers.forEach(m => map.removeLayer(m.marker));
        mapMarkers = [];
        mockLocations.forEach(loc => {
            const color = { 'active': '#22c55e', 'transit': '#22d3ee', 'alert': '#ef4444', 'idle': '#94a3b8', 'break': '#f97316' }[loc.status];
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="relative"><div class="marker-pin" style="background-color: ${color}"></div>${loc.status === 'alert' ? `<div class="marker-pulse" style="background-color: ${color}"></div>` : ''}</div>`,
                iconSize: [14, 14], iconAnchor: [7, 7]
            });
            const marker = L.marker([loc.lat, loc.lng], { icon }).addTo(map);
            marker.bindPopup(`<div class="p-3"><p class="text-[9px] font-black text-slate-400">${loc.id}</p><p class="font-extrabold text-sm">${loc.name}</p><p class="text-[10px] text-slate-500 mt-1">${loc.task}</p></div>`, { closeButton: false, offset: [0, -5] });
            mapMarkers.push({ id: loc.id.toLowerCase(), name: loc.name.toLowerCase(), marker });
        });
    }

    function handleMapSearch(e) {
        const q = e.target.value.toLowerCase();
        const f = mapMarkers.find(m => m.id.includes(q) || m.name.includes(q));
        if (f) { map.flyTo(f.marker.getLatLng(), 15); f.marker.openPopup(); }
    }

    function handleOrderTrack(name) {
        navigate('dashboard');
        setTimeout(() => {
            const f = mapMarkers.find(m => m.name.includes(name.toLowerCase()));
            if (f) { map.flyTo(f.marker.getLatLng(), 16); f.marker.openPopup(); }
        }, 600);
    }
    // --- DRIVER MANAGEMENT MODAL ---
function openManageDriverModal(driverId) {
    const driver = drivers.find(d => d.id === driverId);
    if (!driver) return;

    const content = `
        <div class="p-8">
            <div class="flex justify-between items-start mb-8">
                <div class="flex items-center gap-4">
                    <div class="avatar w-16 h-16 text-xl"><span>${driver.name[0]}</span></div>
                    <div>
                        <h2 class="text-2xl font-black dark:text-white">${driver.name}</h2>
                        <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">${driver.id} • ${driver.vehicle}</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-white transition">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Total Jobs</p>
                    <p class="text-lg font-black dark:text-white">${driver.trips}</p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Rating</p>
                    <p class="text-lg font-black dark:text-white">${driver.rating} <i class="ph ph-star-fill text-yellow-400 text-sm"></i></p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Wallet</p>
                    <p class="text-lg font-black dark:text-white">₹${driver.wallet}</p>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-2">Administrative Actions</h3>
               
<div class="grid grid-cols-2 gap-3">
    <button onclick="handleMessagePartner('${driver.id}')" class="flex items-center justify-center gap-2 py-3.5 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs font-bold dark:text-white hover:bg-slate-200 transition">
        <i class="ph ph-chat-centered-text text-lg text-cyan-500"></i> Message Partner
    </button>
    <button onclick="handleViewHistory('${driver.id}')" class="flex items-center justify-center gap-2 py-3.5 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs font-bold dark:text-white hover:bg-slate-200 transition">
        <i class="ph ph-clock-counter-clockwise text-lg text-cyan-500"></i> Job History
    </button>
    <button onclick="handleWalletView('${driver.id}')" class="flex items-center justify-center gap-2 py-3.5 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs font-bold dark:text-white hover:bg-slate-200 transition">
        <i class="ph ph-wallet text-lg text-cyan-500"></i> Wallet & Payouts
    </button>
    
    <button onclick="togglePartnerStatus('${driver.id}')" class="flex items-center justify-center gap-2 py-3.5 ${driver.status === 'Suspended' ? 'bg-green-50 dark:bg-green-950/20 text-green-500 border border-green-500/20' : 'bg-red-50 dark:bg-red-950/20 text-red-500 border border-red-500/20'} rounded-xl text-xs font-bold hover:opacity-80 transition">
        <i class="ph ${driver.status === 'Suspended' ? 'ph-check-circle' : 'ph-prohibit'} text-lg"></i> 
        ${driver.status === 'Suspended' ? 'Unsuspend Partner' : 'Suspend Partner'}
    </button>
</div>
            </div>

            <div class="mt-8 pt-6 border-t dark:border-slate-800">
                <button onclick="closeModal()" class="w-full bg-black text-cyan-400 dark:bg-cyan-400 dark:text-black py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg transition hover:scale-[1.02]">
                    Close Management File
                </button>
            </div>
        </div>
    `;
    showModal(content);
}

function togglePartnerStatus(id) {
    const driverIndex = drivers.findIndex(d => d.id === id);
    if (driverIndex === -1) return;

    const driver = drivers[driverIndex];
    
    if (driver.status === 'Suspended') {
        // Restore to whatever they were before suspension (Online/Offline/Break)
        driver.status = driver.lastKnownStatus || 'Offline';
        alert(`Partner ${id} has been unsuspended.`);
    } else {
        if(confirm(`Are you sure you want to suspend Partner ${id}?`)) {
            // Save current status before suspending
            driver.lastKnownStatus = driver.status;
            driver.status = 'Suspended';
        }
    }
    
    renderRoster(); 
    openManageDriverModal(id); 
}
// --- MODAL ACTION HANDLERS ---

function handleMessagePartner(id) {
    const driver = drivers.find(d => d.id === id);
    const msg = prompt(`Type your secure message to ${driver.name}:`, "Please check your current location/GPS status.");
    if (msg) {
        alert(`Message encrypted and sent to ${driver.id} terminal.`);
    }
}

function handleViewHistory(id) {
    const driver = drivers.find(d => d.id === id);
    // Generate 10+ history items for demo
    const historyItems = Array.from({length: 12}, (_, i) => ({
        id: `TID-70${100 - i}`,
        type: i % 2 === 0 ? 'Heavy Load' : 'Express Tech',
        date: `${i + 1} Feb 2026`,
        status: 'Completed',
        val: `₹${(Math.random() * 1000 + 500).toFixed(0)}`
    }));

    const historyHtml = `
        <div class="p-8 max-h-[80vh] overflow-y-auto custom-scrollbar">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-lg font-black dark:text-white">Full Job Ledger: ${driver.name}</h3>
                <button onclick="openManageDriverModal('${id}')" class="text-cyan-500 font-bold text-xs uppercase">Back</button>
            </div>
            <div class="space-y-3">
                ${historyItems.map(item => `
                    <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border dark:border-slate-700 flex justify-between items-center">
                        <div>
                            <p class="text-[9px] font-black text-slate-400 uppercase">${item.date}</p>
                            <p class="text-xs font-bold dark:text-white mt-0.5">${item.id}: ${item.type}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-black dark:text-white">${item.val}</p>
                            <p class="text-[9px] text-green-500 font-black uppercase">COMPLETED</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    showModal(historyHtml);
}

function handleWalletView(id) {
    const driver = drivers.find(d => d.id === id);
    // Default bank data if missing in mock
    const bank = driver.bank || { name: 'Bank Not Linked', acc: '----', ifsc: '----' };
    
    const walletHtml = `
        <div class="p-8 max-h-[85vh] overflow-y-auto custom-scrollbar">
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-lg font-black dark:text-white">Earnings & Financial Control</h3>
                <button onclick="openManageDriverModal('${id}')" class="text-cyan-500 font-bold text-xs uppercase">Back</button>
            </div>
            
            <div class="bg-slate-950 p-6 rounded-3xl mb-6 border border-white/10 shadow-2xl">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Withdrawable Balance</p>
                <p class="text-3xl font-black text-white mt-2">₹${driver.wallet.toFixed(2)}</p>
            </div>

            <!-- NEW: Bank Details Card -->
            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 mb-8 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white dark:bg-slate-700 rounded-xl flex items-center justify-center text-slate-400 shadow-sm">
                        <i class="ph ph-bank text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Linked Account</p>
                        <p class="text-sm font-bold dark:text-white mt-0.5">${bank.name}</p>
                        <p class="text-xs text-slate-500 font-medium">${bank.acc} • ${bank.ifsc}</p>
                    </div>
                </div>
                <button class="text-[10px] bg-slate-200 dark:bg-slate-700 px-3 py-1.5 rounded-lg font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 transition">Edit</button>
            </div>

            <div id="dispute-container" class="mb-10">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                    Active Payment Disputes
                </p>
                <div class="p-5 bg-red-50 dark:bg-red-950/20 rounded-2xl border border-red-100 dark:border-red-900/30">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-black dark:text-white">Withdrawal Not Reflected</p>
                            <p class="text-[10px] text-slate-500 mt-1">Ref: #WDR-9921 • Raised 4h ago</p>
                        </div>
                        <button id="resolve-btn" onclick="resolveDispute()" class="text-[10px] bg-red-500 text-white px-4 py-2 rounded-xl font-black uppercase transition hover:scale-105">Resolve Issue</button>
                    </div>
                    <p class="text-[11px] text-red-600 dark:text-red-400 mt-4 italic font-medium">"Money deducted from wallet but not received in bank account."</p>
                </div>
            </div>

            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Lifetime Payout History</p>
                <div class="space-y-1">
                    ${[1,2,3,4,5].map(i => `
                        <div class="flex justify-between items-center py-4 border-b dark:border-slate-800 last:border-0">
                            <div>
                                <p class="text-xs font-bold dark:text-white">Payout #TX-10${i}</p>
                                <p class="text-[9px] text-slate-500 uppercase font-black">Jan ${10+i}, 2026 • UPI</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-black dark:text-white">₹${1000 * i}</p>
                                <p class="text-[9px] text-green-500 font-black uppercase">Success</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    showModal(walletHtml);
}

function resolveDispute() {
    const container = document.getElementById('dispute-container');
    container.innerHTML = `
        <div class="p-5 bg-green-500/10 rounded-2xl border border-green-500/20 flex items-center gap-4 animate-fade-in">
            <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white">
                <i class="ph ph-check-circle text-xl"></i>
            </div>
            <div>
                <p class="text-xs font-black text-green-600 dark:text-green-400 uppercase">Settlement Resolved</p>
                <p class="text-[10px] text-slate-500 font-bold mt-0.5">Funds re-dispatched to partner's primary bank account.</p>
            </div>
        </div>
    `;
}
</script>
</body>
</html>